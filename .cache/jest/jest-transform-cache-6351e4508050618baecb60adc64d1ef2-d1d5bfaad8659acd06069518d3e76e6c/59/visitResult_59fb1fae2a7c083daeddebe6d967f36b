77e465d29f68ad13ad459647cf2ff87c
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.visitResult = exports.visitErrors = exports.visitData = void 0;
const graphql_1 = require("graphql");
const collectFields_1 = require("./collectFields");
function visitData(data, enter, leave) {
    if (Array.isArray(data)) {
        return data.map(value => visitData(value, enter, leave));
    }
    else if (typeof data === 'object') {
        const newData = enter != null ? enter(data) : data;
        if (newData != null) {
            Object.keys(newData).forEach(key => {
                const value = newData[key];
                newData[key] = visitData(value, enter, leave);
            });
        }
        return leave != null ? leave(newData) : newData;
    }
    return data;
}
exports.visitData = visitData;
function visitErrors(errors, visitor) {
    return errors.map(error => visitor(error));
}
exports.visitErrors = visitErrors;
function visitResult(result, request, schema, resultVisitorMap, errorVisitorMap) {
    const partialExecutionContext = {
        schema,
        fragments: request.document.definitions.reduce((acc, def) => {
            if (def.kind === graphql_1.Kind.FRAGMENT_DEFINITION) {
                acc[def.name.value] = def;
            }
            return acc;
        }, {}),
        variableValues: request.variables,
    };
    const errorInfo = {
        segmentInfoMap: new Map(),
        unpathedErrors: new Set(),
    };
    const data = result.data;
    const errors = result.errors;
    const visitingErrors = errors != null && errorVisitorMap != null;
    if (data != null) {
        result.data = visitRoot(data, graphql_1.getOperationAST(request.document, undefined), partialExecutionContext, resultVisitorMap, visitingErrors ? errors : undefined, errorInfo);
    }
    if (visitingErrors) {
        result.errors = visitErrorsByType(errors, errorVisitorMap, errorInfo);
    }
    return result;
}
exports.visitResult = visitResult;
function visitErrorsByType(errors, errorVisitorMap, errorInfo) {
    const segmentInfoMap = errorInfo.segmentInfoMap;
    const unpathedErrors = errorInfo.unpathedErrors;
    const unpathedErrorVisitor = errorVisitorMap['__unpathed'];
    return errors.map(originalError => {
        const pathSegmentsInfo = segmentInfoMap.get(originalError);
        const newError = pathSegmentsInfo == null
            ? originalError
            : pathSegmentsInfo.reduceRight((acc, segmentInfo) => {
                const typeName = segmentInfo.type.name;
                const typeVisitorMap = errorVisitorMap[typeName];
                if (typeVisitorMap == null) {
                    return acc;
                }
                const errorVisitor = typeVisitorMap[segmentInfo.fieldName];
                return errorVisitor == null ? acc : errorVisitor(acc, segmentInfo.pathIndex);
            }, originalError);
        if (unpathedErrorVisitor && unpathedErrors.has(originalError)) {
            return unpathedErrorVisitor(newError);
        }
        return newError;
    });
}
function visitRoot(root, operation, exeContext, resultVisitorMap, errors, errorInfo) {
    const operationRootType = graphql_1.getOperationRootType(exeContext.schema, operation);
    const collectedFields = collectFields_1.collectFields(exeContext, operationRootType, operation.selectionSet, Object.create(null), Object.create(null));
    return visitObjectValue(root, operationRootType, collectedFields, exeContext, resultVisitorMap, 0, errors, errorInfo);
}
function visitObjectValue(object, type, fieldNodeMap, exeContext, resultVisitorMap, pathIndex, errors, errorInfo) {
    const fieldMap = type.getFields();
    const typeVisitorMap = resultVisitorMap === null || resultVisitorMap === void 0 ? void 0 : resultVisitorMap[type.name];
    const enterObject = typeVisitorMap === null || typeVisitorMap === void 0 ? void 0 : typeVisitorMap.__enter;
    const newObject = enterObject != null ? enterObject(object) : object;
    let sortedErrors;
    let errorMap;
    if (errors != null) {
        sortedErrors = sortErrorsByPathSegment(errors, pathIndex);
        errorMap = sortedErrors.errorMap;
        sortedErrors.unpathedErrors.forEach(error => errorInfo.unpathedErrors.add(error));
    }
    Object.keys(fieldNodeMap).forEach(responseKey => {
        const subFieldNodes = fieldNodeMap[responseKey];
        const fieldName = subFieldNodes[0].name.value;
        const fieldType = fieldMap[fieldName].type;
        const newPathIndex = pathIndex + 1;
        let fieldErrors;
        if (errors != null) {
            fieldErrors = errorMap[responseKey];
            if (fieldErrors != null) {
                delete errorMap[responseKey];
            }
            addPathSegmentInfo(type, fieldName, newPathIndex, fieldErrors, errorInfo);
        }
        const newValue = visitFieldValue(object[responseKey], fieldType, subFieldNodes, exeContext, resultVisitorMap, newPathIndex, fieldErrors, errorInfo);
        updateObject(newObject, responseKey, newValue, typeVisitorMap, fieldName);
    });
    const oldTypename = newObject.__typename;
    if (oldTypename != null) {
        updateObject(newObject, '__typename', oldTypename, typeVisitorMap, '__typename');
    }
    if (errors != null) {
        Object.keys(errorMap).forEach(unknownResponseKey => {
            errorMap[unknownResponseKey].forEach(error => errorInfo.unpathedErrors.add(error));
        });
    }
    const leaveObject = typeVisitorMap === null || typeVisitorMap === void 0 ? void 0 : typeVisitorMap.__leave;
    return leaveObject != null ? leaveObject(newObject) : newObject;
}
function updateObject(object, responseKey, newValue, typeVisitorMap, fieldName) {
    if (typeVisitorMap == null) {
        object[responseKey] = newValue;
        return;
    }
    const fieldVisitor = typeVisitorMap[fieldName];
    if (fieldVisitor == null) {
        object[responseKey] = newValue;
        return;
    }
    const visitedValue = fieldVisitor(newValue);
    if (visitedValue === undefined) {
        delete object[responseKey];
        return;
    }
    object[responseKey] = visitedValue;
}
function visitListValue(list, returnType, fieldNodes, exeContext, resultVisitorMap, pathIndex, errors, errorInfo) {
    return list.map(listMember => visitFieldValue(listMember, returnType, fieldNodes, exeContext, resultVisitorMap, pathIndex + 1, errors, errorInfo));
}
function visitFieldValue(value, returnType, fieldNodes, exeContext, resultVisitorMap, pathIndex, errors = [], errorInfo) {
    if (value == null) {
        return value;
    }
    const nullableType = graphql_1.getNullableType(returnType);
    if (graphql_1.isListType(nullableType)) {
        return visitListValue(value, nullableType.ofType, fieldNodes, exeContext, resultVisitorMap, pathIndex, errors, errorInfo);
    }
    else if (graphql_1.isAbstractType(nullableType)) {
        const finalType = exeContext.schema.getType(value.__typename);
        const collectedFields = collectSubFields(exeContext, finalType, fieldNodes);
        return visitObjectValue(value, finalType, collectedFields, exeContext, resultVisitorMap, pathIndex, errors, errorInfo);
    }
    else if (graphql_1.isObjectType(nullableType)) {
        const collectedFields = collectSubFields(exeContext, nullableType, fieldNodes);
        return visitObjectValue(value, nullableType, collectedFields, exeContext, resultVisitorMap, pathIndex, errors, errorInfo);
    }
    const typeVisitorMap = resultVisitorMap === null || resultVisitorMap === void 0 ? void 0 : resultVisitorMap[nullableType.name];
    if (typeVisitorMap == null) {
        return value;
    }
    const visitedValue = typeVisitorMap(value);
    return visitedValue === undefined ? value : visitedValue;
}
function sortErrorsByPathSegment(errors, pathIndex) {
    const errorMap = Object.create(null);
    const unpathedErrors = new Set();
    errors.forEach(error => {
        var _a;
        const pathSegment = (_a = error.path) === null || _a === void 0 ? void 0 : _a[pathIndex];
        if (pathSegment == null) {
            unpathedErrors.add(error);
            return;
        }
        if (pathSegment in errorMap) {
            errorMap[pathSegment].push(error);
        }
        else {
            errorMap[pathSegment] = [error];
        }
    });
    return {
        errorMap,
        unpathedErrors,
    };
}
function addPathSegmentInfo(type, fieldName, pathIndex, errors = [], errorInfo) {
    errors.forEach(error => {
        const segmentInfo = {
            type,
            fieldName,
            pathIndex,
        };
        const pathSegmentsInfo = errorInfo.segmentInfoMap.get(error);
        if (pathSegmentsInfo == null) {
            errorInfo.segmentInfoMap.set(error, [segmentInfo]);
        }
        else {
            pathSegmentsInfo.push(segmentInfo);
        }
    });
}
function collectSubFields(exeContext, type, fieldNodes) {
    let subFieldNodes = Object.create(null);
    const visitedFragmentNames = Object.create(null);
    fieldNodes.forEach(fieldNode => {
        subFieldNodes = collectFields_1.collectFields(exeContext, type, fieldNode.selectionSet, subFieldNodes, visitedFragmentNames);
    });
    return subFieldNodes;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJkYXRfMDAwL0d1aWxkL2dyYXBocWwtdG9vbHMvcGFja2FnZXMvdXRpbHMvc3JjL3Zpc2l0UmVzdWx0LnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHFDQWNpQjtBQUdqQixtREFBZ0Q7QUFpQ2hELFNBQWdCLFNBQVMsQ0FBQyxJQUFTLEVBQUUsS0FBb0IsRUFBRSxLQUFvQjtJQUM3RSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDdkIsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztLQUMxRDtTQUFNLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFO1FBQ25DLE1BQU0sT0FBTyxHQUFHLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBRW5ELElBQUksT0FBTyxJQUFJLElBQUksRUFBRTtZQUNuQixNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDakMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUMzQixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsU0FBUyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDaEQsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUVELE9BQU8sS0FBSyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7S0FDakQ7SUFFRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFqQkQsOEJBaUJDO0FBRUQsU0FBZ0IsV0FBVyxDQUN6QixNQUFtQyxFQUNuQyxPQUE4QztJQUU5QyxPQUFPLE1BQU0sQ0FBQyxHQUFH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QUFHLENBQUMsS0FBSyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztTQUNwRDthQUFNO1lBQ0wsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ3BDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FDdkIsVUFBbUMsRUFDbkMsSUFBdUIsRUFDdkIsVUFBNEI7SUFFNUIsSUFBSSxhQUFhLEdBQXFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUUsTUFBTSxvQkFBb0IsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRWpELFVBQVUsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUU7UUFDN0IsYUFBYSxHQUFHLDZCQUFhLENBQUMsVUFBVSxFQUFFLElBQUksRUFBRSxTQUFTLENBQUMsWUFBWSxFQUFFLGFBQWEsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO0lBQy9HLENBQUMsQ0FBQyxDQUFDO0lBRUgsT0FBTyxhQUFhLENBQUM7QUFDdkIsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9hcmRhdF8wMDAvR3VpbGQvZ3JhcGhxbC10b29scy9wYWNrYWdlcy91dGlscy9zcmMvdmlzaXRSZXN1bHQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgR3JhcGhRTFNjaGVtYSxcbiAgZ2V0T3BlcmF0aW9uUm9vdFR5cGUsXG4gIGdldE9wZXJhdGlvbkFTVCxcbiAgS2luZCxcbiAgR3JhcGhRTE9iamVjdFR5cGUsXG4gIEZpZWxkTm9kZSxcbiAgR3JhcGhRTE91dHB1dFR5cGUsXG4gIGlzTGlzdFR5cGUsXG4gIGdldE51bGxhYmxlVHlwZSxcbiAgaXNBYnN0cmFjdFR5cGUsXG4gIGlzT2JqZWN0VHlwZSxcbiAgT3BlcmF0aW9uRGVmaW5pdGlvbk5vZGUsXG4gIEdyYXBoUUxFcnJvcixcbn0gZnJvbSAnZ3JhcGhxbCc7XG5cbmltcG9ydCB7IFJlcXVlc3QsIEdyYXBoUUxFeGVjdXRpb25Db250ZXh0LCBFeGVjdXRpb25SZXN1bHQgfSBmcm9tICcuL0ludGVyZmFjZXMnO1xuaW1wb3J0IHsgY29sbGVjdEZpZWxkcyB9IGZyb20gJy4vY29sbGVjdEZpZWxkcyc7XG5cbmV4cG9ydCB0eXBlIFZhbHVlVmlzaXRvciA9ICh2YWx1ZTogYW55KSA9PiBhbnk7XG5cbmV4cG9ydCB0eXBlIE9iamVjdFZhbHVlVmlzaXRvciA9IHtcbiAgX19lbnRlcj86IFZhbHVlVmlzaXRvcjtcbiAgX19sZWF2ZT86IFZhbHVlVmlzaXRvcjtcbn0gJiBSZWNvcmQ8c3RyaW5nLCBWYWx1ZVZpc2l0b3I+O1xuXG5leHBvcnQgdHlwZSBSZXN1bHRWaXNpdG9yTWFwID0gUmVjb3JkPHN0cmluZywgVmFsdWVWaXNpdG9yIHwgT2JqZWN0VmFsdWVWaXNpdG9yPjtcblxuZXhwb3J0IHR5cGUgRXJyb3JWaXNpdG9yID0gKGVycm9yOiBHcmFwaFFMRXJyb3IsIHBhdGhJbmRleDogbnVtYmVyKSA9PiBHcmFwaFFMRXJyb3I7XG5cbmV4cG9ydCB0eXBlIEVycm9yVmlzaXRvck1hcCA9IHtcbiAgX191bnBhdGhlZD86IChlcnJvcjogR3JhcGhRTEVycm9yKSA9PiBHcmFwaFFMRXJyb3I7XG59ICYgUmVjb3JkPHN0cmluZywgUmVjb3JkPHN0cmluZywgRXJyb3JWaXNpdG9yPj47XG5cbmludGVyZmFjZSBTZWdtZW50SW5mbyB7XG4gIHR5cGU6IEdyYXBoUUxPYmplY3RUeXBlO1xuICBmaWVsZE5hbWU6IHN0cmluZztcbiAgcGF0aEluZGV4OiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBFcnJvckluZm8ge1xuICBzZWdtZW50SW5mb01hcDogTWFwPEdyYXBoUUxFcnJvciwgQXJyYXk8U2VnbWVudEluZm8+PjtcbiAgdW5wYXRoZWRFcnJvcnM6IFNldDxHcmFwaFFMRXJyb3I+O1xufVxuXG5pbnRlcmZhY2UgU29ydGVkRXJyb3JzIHtcbiAgZXJyb3JNYXA6IFJlY29yZDxzdHJpbmcsIEFycmF5PEdyYXBoUUxFcnJvcj4+O1xuICB1bnBhdGhlZEVycm9yczogU2V0PEdyYXBoUUxFcnJvcj47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB2aXNpdERhdGEoZGF0YTogYW55LCBlbnRlcj86IFZhbHVlVmlzaXRvciwgbGVhdmU/OiBWYWx1ZVZpc2l0b3IpOiBhbnkge1xuICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkge1xuICAgIHJldHVybiBkYXRhLm1hcCh2YWx1ZSA9PiB2aXNpdERhdGEodmFsdWUsIGVudGVyLCBsZWF2ZSkpO1xuICB9IGVsc2UgaWYgKHR5cGVvZiBkYXRhID09PSAnb2JqZWN0Jykge1xuICAgIGNvbnN0IG5ld0RhdGEgPSBlbnRlciAhPSBudWxsID8gZW50ZXIoZGF0YSkgOiBkYXRhO1xuXG4gICAgaWYgKG5ld0RhdGEgIT0gbnVsbCkge1xuICAgICAgT2JqZWN0LmtleXMobmV3RGF0YSkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IG5ld0RhdGFba2V5XTtcbiAgICAgICAgbmV3RGF0YVtrZXldID0gdmlzaXREYXRhKHZhbHVlLCBlbnRlciwgbGVhdmUpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGxlYXZlICE9IG51bGwgPyBsZWF2ZShuZXdEYXRhKSA6IG5ld0RhdGE7XG4gIH1cblxuICByZXR1cm4gZGF0YTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHZpc2l0RXJyb3JzKFxuICBlcnJvcnM6IFJlYWRvbmx5QXJyYXk8R3JhcGhRTEVycm9yPixcbiAgdmlzaXRvcjogKGVycm9yOiBHcmFwaFFMRXJyb3IpID0+IEdyYXBoUUxFcnJvclxuKTogQXJyYXk8R3JhcGhRTEVycm9yPiB7XG4gIHJldHVybiBlcnJvcnMubWFwKGVycm9yID0+IHZpc2l0b3IoZXJyb3IpKTtcbn1cbmV4cG9ydCBmdW5jdGlvbiB2aXNpdFJlc3VsdChcbiAgcmVzdWx0OiBFeGVjdXRpb25SZXN1bHQsXG4gIHJlcXVlc3Q6IFJlcXVlc3QsXG4gIHNjaGVtYTogR3JhcGhRTFNjaGVtYSxcbiAgcmVzdWx0VmlzaXRvck1hcD86IFJlc3VsdFZpc2l0b3JNYXAsXG4gIGVycm9yVmlzaXRvck1hcD86IEVycm9yVmlzaXRvck1hcFxuKTogYW55IHtcbiAgY29uc3QgcGFydGlhbEV4ZWN1dGlvbkNvbnRleHQgPSB7XG4gICAgc2NoZW1hLFxuICAgIGZyYWdtZW50czogcmVxdWVzdC5kb2N1bWVudC5kZWZpbml0aW9ucy5yZWR1Y2UoKGFjYywgZGVmKSA9PiB7XG4gICAgICBpZiAoZGVmLmtpbmQgPT09IEtpbmQuRlJBR01FTlRfREVGSU5JVElPTikge1xuICAgICAgICBhY2NbZGVmLm5hbWUudmFsdWVdID0gZGVmO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSksXG4gICAgdmFyaWFibGVWYWx1ZXM6IHJlcXVlc3QudmFyaWFibGVzLFxuICB9IGFzIEdyYXBoUUxFeGVjdXRpb25Db250ZXh0O1xuXG4gIGNvbnN0IGVycm9ySW5mbzogRXJyb3JJbmZvID0ge1xuICAgIHNlZ21lbnRJbmZvTWFwOiBuZXcgTWFwPEdyYXBoUUxFcnJvciwgQXJyYXk8U2VnbWVudEluZm8+PigpLFxuICAgIHVucGF0aGVkRXJyb3JzOiBuZXcgU2V0PEdyYXBoUUxFcnJvcj4oKSxcbiAgfTtcblxuICBjb25zdCBkYXRhID0gcmVzdWx0LmRhdGE7XG4gIGNvbnN0IGVycm9ycyA9IHJlc3VsdC5lcnJvcnM7XG4gIGNvbnN0IHZpc2l0aW5nRXJyb3JzID0gZXJyb3JzICE9IG51bGwgJiYgZXJyb3JWaXNpdG9yTWFwICE9IG51bGw7XG5cbiAgaWYgKGRhdGEgIT0gbnVsbCkge1xuICAgIHJlc3VsdC5kYXRhID0gdmlzaXRSb290KFxuICAgICAgZGF0YSxcbiAgICAgIGdldE9wZXJhdGlvbkFTVChyZXF1ZXN0LmRvY3VtZW50LCB1bmRlZmluZWQpLFxuICAgICAgcGFydGlhbEV4ZWN1dGlvbkNvbnRleHQsXG4gICAgICByZXN1bHRWaXNpdG9yTWFwLFxuICAgICAgdmlzaXRpbmdFcnJvcnMgPyBlcnJvcnMgOiB1bmRlZmluZWQsXG4gICAgICBlcnJvckluZm9cbiAgICApO1xuICB9XG5cbiAgaWYgKHZpc2l0aW5nRXJyb3JzKSB7XG4gICAgcmVzdWx0LmVycm9ycyA9IHZpc2l0RXJyb3JzQnlUeXBlKGVycm9ycywgZXJyb3JWaXNpdG9yTWFwLCBlcnJvckluZm8pO1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gdmlzaXRFcnJvcnNCeVR5cGUoXG4gIGVycm9yczogUmVhZG9ubHlBcnJheTxHcmFwaFFMRXJyb3I+LFxuICBlcnJvclZpc2l0b3JNYXA6IEVycm9yVmlzaXRvck1hcCxcbiAgZXJyb3JJbmZvOiBFcnJvckluZm9cbik6IEFycmF5PEdyYXBoUUxFcnJvcj4ge1xuICBjb25zdCBzZWdtZW50SW5mb01hcCA9IGVycm9ySW5mby5zZWdtZW50SW5mb01hcDtcbiAgY29uc3QgdW5wYXRoZWRFcnJvcnMgPSBlcnJvckluZm8udW5wYXRoZWRFcnJvcnM7XG4gIGNvbnN0IHVucGF0aGVkRXJyb3JWaXNpdG9yID0gZXJyb3JWaXNpdG9yTWFwWydfX3VucGF0aGVkJ107XG5cbiAgcmV0dXJuIGVycm9ycy5tYXAob3JpZ2luYWxFcnJvciA9PiB7XG4gICAgY29uc3QgcGF0aFNlZ21lbnRzSW5mbyA9IHNlZ21lbnRJbmZvTWFwLmdldChvcmlnaW5hbEVycm9yKTtcbiAgICBjb25zdCBuZXdFcnJvciA9XG4gICAgICBwYXRoU2VnbWVudHNJbmZvID09IG51bGxcbiAgICAgICAgPyBvcmlnaW5hbEVycm9yXG4gICAgICAgIDogcGF0aFNlZ21lbnRzSW5mby5yZWR1Y2VSaWdodCgoYWNjLCBzZWdtZW50SW5mbykgPT4ge1xuICAgICAgICAgICAgY29uc3QgdHlwZU5hbWUgPSBzZWdtZW50SW5mby50eXBlLm5hbWU7XG4gICAgICAgICAgICBjb25zdCB0eXBlVmlzaXRvck1hcCA9IGVycm9yVmlzaXRvck1hcFt0eXBlTmFtZV07XG4gICAgICAgICAgICBpZiAodHlwZVZpc2l0b3JNYXAgPT0gbnVsbCkge1xuICAgICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZXJyb3JWaXNpdG9yID0gdHlwZVZpc2l0b3JNYXBbc2VnbWVudEluZm8uZmllbGROYW1lXTtcbiAgICAgICAgICAgIHJldHVybiBlcnJvclZpc2l0b3IgPT0gbnVsbCA/IGFjYyA6IGVycm9yVmlzaXRvcihhY2MsIHNlZ21lbnRJbmZvLnBhdGhJbmRleCk7XG4gICAgICAgICAgfSwgb3JpZ2luYWxFcnJvcik7XG5cbiAgICBpZiAodW5wYXRoZWRFcnJvclZpc2l0b3IgJiYgdW5wYXRoZWRFcnJvcnMuaGFzKG9yaWdpbmFsRXJyb3IpKSB7XG4gICAgICByZXR1cm4gdW5wYXRoZWRFcnJvclZpc2l0b3IobmV3RXJyb3IpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXdFcnJvcjtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHZpc2l0Um9vdChcbiAgcm9vdDogYW55LFxuICBvcGVyYXRpb246IE9wZXJhdGlvbkRlZmluaXRpb25Ob2RlLFxuICBleGVDb250ZXh0OiBHcmFwaFFMRXhlY3V0aW9uQ29udGV4dCxcbiAgcmVzdWx0VmlzaXRvck1hcDogUmVzdWx0VmlzaXRvck1hcCxcbiAgZXJyb3JzOiBSZWFkb25seUFycmF5PEdyYXBoUUxFcnJvcj4sXG4gIGVycm9ySW5mbzogRXJyb3JJbmZvXG4pOiBhbnkge1xuICBjb25zdCBvcGVyYXRpb25Sb290VHlwZSA9IGdldE9wZXJhdGlvblJvb3RUeXBlKGV4ZUNvbnRleHQuc2NoZW1hLCBvcGVyYXRpb24pO1xuICBjb25zdCBjb2xsZWN0ZWRGaWVsZHMgPSBjb2xsZWN0RmllbGRzKFxuICAgIGV4ZUNvbnRleHQsXG4gICAgb3BlcmF0aW9uUm9vdFR5cGUsXG4gICAgb3BlcmF0aW9uLnNlbGVjdGlvblNldCxcbiAgICBPYmplY3QuY3JlYXRlKG51bGwpLFxuICAgIE9iamVjdC5jcmVhdGUobnVsbClcbiAgKTtcblxuICByZXR1cm4gdmlzaXRPYmplY3RWYWx1ZShyb290LCBvcGVyYXRpb25Sb290VHlwZSwgY29sbGVjdGVkRmllbGRzLCBleGVDb250ZXh0LCByZXN1bHRWaXNpdG9yTWFwLCAwLCBlcnJvcnMsIGVycm9ySW5mbyk7XG59XG5cbmZ1bmN0aW9uIHZpc2l0T2JqZWN0VmFsdWUoXG4gIG9iamVjdDogUmVjb3JkPHN0cmluZywgYW55PixcbiAgdHlwZTogR3JhcGhRTE9iamVjdFR5cGUsXG4gIGZpZWxkTm9kZU1hcDogUmVjb3JkPHN0cmluZywgQXJyYXk8RmllbGROb2RlPj4sXG4gIGV4ZUNvbnRleHQ6IEdyYXBoUUxFeGVjdXRpb25Db250ZXh0LFxuICByZXN1bHRWaXNpdG9yTWFwOiBSZXN1bHRWaXNpdG9yTWFwLFxuICBwYXRoSW5kZXg6IG51bWJlcixcbiAgZXJyb3JzOiBSZWFkb25seUFycmF5PEdyYXBoUUxFcnJvcj4sXG4gIGVycm9ySW5mbzogRXJyb3JJbmZvXG4pOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgY29uc3QgZmllbGRNYXAgPSB0eXBlLmdldEZpZWxkcygpO1xuICBjb25zdCB0eXBlVmlzaXRvck1hcCA9IHJlc3VsdFZpc2l0b3JNYXA/Llt0eXBlLm5hbWVdIGFzIE9iamVjdFZhbHVlVmlzaXRvcjtcblxuICBjb25zdCBlbnRlck9iamVjdCA9IHR5cGVWaXNpdG9yTWFwPy5fX2VudGVyIGFzIFZhbHVlVmlzaXRvcjtcbiAgY29uc3QgbmV3T2JqZWN0ID0gZW50ZXJPYmplY3QgIT0gbnVsbCA/IGVudGVyT2JqZWN0KG9iamVjdCkgOiBvYmplY3Q7XG5cbiAgbGV0IHNvcnRlZEVycm9yczogU29ydGVkRXJyb3JzO1xuICBsZXQgZXJyb3JNYXA6IFJlY29yZDxzdHJpbmcsIEFycmF5PEdyYXBoUUxFcnJvcj4+O1xuICBpZiAoZXJyb3JzICE9IG51bGwpIHtcbiAgICBzb3J0ZWRFcnJvcnMgPSBzb3J0RXJyb3JzQnlQYXRoU2VnbWVudChlcnJvcnMsIHBhdGhJbmRleCk7XG4gICAgZXJyb3JNYXAgPSBzb3J0ZWRFcnJvcnMuZXJyb3JNYXA7XG4gICAgc29ydGVkRXJyb3JzLnVucGF0aGVkRXJyb3JzLmZvckVhY2goZXJyb3IgPT4gZXJyb3JJbmZvLnVucGF0aGVkRXJyb3JzLmFkZChlcnJvcikpO1xuICB9XG5cbiAgT2JqZWN0LmtleXMoZmllbGROb2RlTWFwKS5mb3JFYWNoKHJlc3BvbnNlS2V5ID0+IHtcbiAgICBjb25zdCBzdWJGaWVsZE5vZGVzID0gZmllbGROb2RlTWFwW3Jlc3BvbnNlS2V5XTtcbiAgICBjb25zdCBmaWVsZE5hbWUgPSBzdWJGaWVsZE5vZGVzWzBdLm5hbWUudmFsdWU7XG4gICAgY29uc3QgZmllbGRUeXBlID0gZmllbGRNYXBbZmllbGROYW1lXS50eXBlO1xuXG4gICAgY29uc3QgbmV3UGF0aEluZGV4ID0gcGF0aEluZGV4ICsgMTtcblxuICAgIGxldCBmaWVsZEVycm9yczogQXJyYXk8R3JhcGhRTEVycm9yPjtcbiAgICBpZiAoZXJyb3JzICE9IG51bGwpIHtcbiAgICAgIGZpZWxkRXJyb3JzID0gZXJyb3JNYXBbcmVzcG9uc2VLZXldO1xuICAgICAgaWYgKGZpZWxkRXJyb3JzICE9IG51bGwpIHtcbiAgICAgICAgZGVsZXRlIGVycm9yTWFwW3Jlc3BvbnNlS2V5XTtcbiAgICAgIH1cbiAgICAgIGFkZFBhdGhTZWdtZW50SW5mbyh0eXBlLCBmaWVsZE5hbWUsIG5ld1BhdGhJbmRleCwgZmllbGRFcnJvcnMsIGVycm9ySW5mbyk7XG4gICAgfVxuXG4gICAgY29uc3QgbmV3VmFsdWUgPSB2aXNpdEZpZWxkVmFsdWUoXG4gICAgICBvYmplY3RbcmVzcG9uc2VLZXldLFxuICAgICAgZmllbGRUeXBlLFxuICAgICAgc3ViRmllbGROb2RlcyxcbiAgICAgIGV4ZUNvbnRleHQsXG4gICAgICByZXN1bHRWaXNpdG9yTWFwLFxuICAgICAgbmV3UGF0aEluZGV4LFxuICAgICAgZmllbGRFcnJvcnMsXG4gICAgICBlcnJvckluZm9cbiAgICApO1xuXG4gICAgdXBkYXRlT2JqZWN0KG5ld09iamVjdCwgcmVzcG9uc2VLZXksIG5ld1ZhbHVlLCB0eXBlVmlzaXRvck1hcCwgZmllbGROYW1lKTtcbiAgfSk7XG5cbiAgY29uc3Qgb2xkVHlwZW5hbWUgPSBuZXdPYmplY3QuX190eXBlbmFtZTtcbiAgaWYgKG9sZFR5cGVuYW1lICE9IG51bGwpIHtcbiAgICB1cGRhdGVPYmplY3QobmV3T2JqZWN0LCAnX190eXBlbmFtZScsIG9sZFR5cGVuYW1lLCB0eXBlVmlzaXRvck1hcCwgJ19fdHlwZW5hbWUnKTtcbiAgfVxuXG4gIGlmIChlcnJvcnMgIT0gbnVsbCkge1xuICAgIE9iamVjdC5rZXlzKGVycm9yTWFwKS5mb3JFYWNoKHVua25vd25SZXNwb25zZUtleSA9PiB7XG4gICAgICBlcnJvck1hcFt1bmtub3duUmVzcG9uc2VLZXldLmZvckVhY2goZXJyb3IgPT4gZXJyb3JJbmZvLnVucGF0aGVkRXJyb3JzLmFkZChlcnJvcikpO1xuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgbGVhdmVPYmplY3QgPSB0eXBlVmlzaXRvck1hcD8uX19sZWF2ZSBhcyBWYWx1ZVZpc2l0b3I7XG5cbiAgcmV0dXJuIGxlYXZlT2JqZWN0ICE9IG51bGwgPyBsZWF2ZU9iamVjdChuZXdPYmplY3QpIDogbmV3T2JqZWN0O1xufVxuXG5mdW5jdGlvbiB1cGRhdGVPYmplY3QoXG4gIG9iamVjdDogUmVjb3JkPHN0cmluZywgYW55PixcbiAgcmVzcG9uc2VLZXk6IHN0cmluZyxcbiAgbmV3VmFsdWU6IGFueSxcbiAgdHlwZVZpc2l0b3JNYXA6IE9iamVjdFZhbHVlVmlzaXRvcixcbiAgZmllbGROYW1lOiBzdHJpbmdcbik6IHZvaWQge1xuICBpZiAodHlwZVZpc2l0b3JNYXAgPT0gbnVsbCkge1xuICAgIG9iamVjdFtyZXNwb25zZUtleV0gPSBuZXdWYWx1ZTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBmaWVsZFZpc2l0b3IgPSB0eXBlVmlzaXRvck1hcFtmaWVsZE5hbWVdO1xuICBpZiAoZmllbGRWaXNpdG9yID09IG51bGwpIHtcbiAgICBvYmplY3RbcmVzcG9uc2VLZXldID0gbmV3VmFsdWU7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgdmlzaXRlZFZhbHVlID0gZmllbGRWaXNpdG9yKG5ld1ZhbHVlKTtcbiAgaWYgKHZpc2l0ZWRWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgZGVsZXRlIG9iamVjdFtyZXNwb25zZUtleV07XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgb2JqZWN0W3Jlc3BvbnNlS2V5XSA9IHZpc2l0ZWRWYWx1ZTtcbn1cblxuZnVuY3Rpb24gdmlzaXRMaXN0VmFsdWUoXG4gIGxpc3Q6IEFycmF5PGFueT4sXG4gIHJldHVyblR5cGU6IEdyYXBoUUxPdXRwdXRUeXBlLFxuICBmaWVsZE5vZGVzOiBBcnJheTxGaWVsZE5vZGU+LFxuICBleGVDb250ZXh0OiBHcmFwaFFMRXhlY3V0aW9uQ29udGV4dCxcbiAgcmVzdWx0VmlzaXRvck1hcDogUmVzdWx0VmlzaXRvck1hcCxcbiAgcGF0aEluZGV4OiBudW1iZXIsXG4gIGVycm9yczogUmVhZG9ubHlBcnJheTxHcmFwaFFMRXJyb3I+LFxuICBlcnJvckluZm86IEVycm9ySW5mb1xuKTogQXJyYXk8YW55PiB7XG4gIHJldHVybiBsaXN0Lm1hcChsaXN0TWVtYmVyID0+XG4gICAgdmlzaXRGaWVsZFZhbHVlKGxpc3RNZW1iZXIsIHJldHVyblR5cGUsIGZpZWxkTm9kZXMsIGV4ZUNvbnRleHQsIHJlc3VsdFZpc2l0b3JNYXAsIHBhdGhJbmRleCArIDEsIGVycm9ycywgZXJyb3JJbmZvKVxuICApO1xufVxuXG5mdW5jdGlvbiB2aXNpdEZpZWxkVmFsdWUoXG4gIHZhbHVlOiBhbnksXG4gIHJldHVyblR5cGU6IEdyYXBoUUxPdXRwdXRUeXBlLFxuICBmaWVsZE5vZGVzOiBBcnJheTxGaWVsZE5vZGU+LFxuICBleGVDb250ZXh0OiBHcmFwaFFMRXhlY3V0aW9uQ29udGV4dCxcbiAgcmVzdWx0VmlzaXRvck1hcDogUmVzdWx0VmlzaXRvck1hcCxcbiAgcGF0aEluZGV4OiBudW1iZXIsXG4gIGVycm9yczogUmVhZG9ubHlBcnJheTxHcmFwaFFMRXJyb3I+ID0gW10sXG4gIGVycm9ySW5mbzogRXJyb3JJbmZvXG4pOiBhbnkge1xuICBpZiAodmFsdWUgPT0gbnVsbCkge1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIGNvbnN0IG51bGxhYmxlVHlwZSA9IGdldE51bGxhYmxlVHlwZShyZXR1cm5UeXBlKTtcbiAgaWYgKGlzTGlzdFR5cGUobnVsbGFibGVUeXBlKSkge1xuICAgIHJldHVybiB2aXNpdExpc3RWYWx1ZShcbiAgICAgIHZhbHVlIGFzIEFycmF5PGFueT4sXG4gICAgICBudWxsYWJsZVR5cGUub2ZUeXBlLFxuICAgICAgZmllbGROb2RlcyxcbiAgICAgIGV4ZUNvbnRleHQsXG4gICAgICByZXN1bHRWaXNpdG9yTWFwLFxuICAgICAgcGF0aEluZGV4LFxuICAgICAgZXJyb3JzLFxuICAgICAgZXJyb3JJbmZvXG4gICAgKTtcbiAgfSBlbHNlIGlmIChpc0Fic3RyYWN0VHlwZShudWxsYWJsZVR5cGUpKSB7XG4gICAgY29uc3QgZmluYWxUeXBlID0gZXhlQ29udGV4dC5zY2hlbWEuZ2V0VHlwZSh2YWx1ZS5fX3R5cGVuYW1lKSBhcyBHcmFwaFFMT2JqZWN0VHlwZTtcbiAgICBjb25zdCBjb2xsZWN0ZWRGaWVsZHMgPSBjb2xsZWN0U3ViRmllbGRzKGV4ZUNvbnRleHQsIGZpbmFsVHlwZSwgZmllbGROb2Rlcyk7XG4gICAgcmV0dXJuIHZpc2l0T2JqZWN0VmFsdWUoXG4gICAgICB2YWx1ZSxcbiAgICAgIGZpbmFsVHlwZSxcbiAgICAgIGNvbGxlY3RlZEZpZWxkcyxcbiAgICAgIGV4ZUNvbnRleHQsXG4gICAgICByZXN1bHRWaXNpdG9yTWFwLFxuICAgICAgcGF0aEluZGV4LFxuICAgICAgZXJyb3JzLFxuICAgICAgZXJyb3JJbmZvXG4gICAgKTtcbiAgfSBlbHNlIGlmIChpc09iamVjdFR5cGUobnVsbGFibGVUeXBlKSkge1xuICAgIGNvbnN0IGNvbGxlY3RlZEZpZWxkcyA9IGNvbGxlY3RTdWJGaWVsZHMoZXhlQ29udGV4dCwgbnVsbGFibGVUeXBlLCBmaWVsZE5vZGVzKTtcbiAgICByZXR1cm4gdmlzaXRPYmplY3RWYWx1ZShcbiAgICAgIHZhbHVlLFxuICAgICAgbnVsbGFibGVUeXBlLFxuICAgICAgY29sbGVjdGVkRmllbGRzLFxuICAgICAgZXhlQ29udGV4dCxcbiAgICAgIHJlc3VsdFZpc2l0b3JNYXAsXG4gICAgICBwYXRoSW5kZXgsXG4gICAgICBlcnJvcnMsXG4gICAgICBlcnJvckluZm9cbiAgICApO1xuICB9XG5cbiAgY29uc3QgdHlwZVZpc2l0b3JNYXAgPSByZXN1bHRWaXNpdG9yTWFwPy5bbnVsbGFibGVUeXBlLm5hbWVdIGFzIFZhbHVlVmlzaXRvcjtcbiAgaWYgKHR5cGVWaXNpdG9yTWFwID09IG51bGwpIHtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICBjb25zdCB2aXNpdGVkVmFsdWUgPSB0eXBlVmlzaXRvck1hcCh2YWx1ZSk7XG4gIHJldHVybiB2aXNpdGVkVmFsdWUgPT09IHVuZGVmaW5lZCA/IHZhbHVlIDogdmlzaXRlZFZhbHVlO1xufVxuXG5mdW5jdGlvbiBzb3J0RXJyb3JzQnlQYXRoU2VnbWVudChlcnJvcnM6IFJlYWRvbmx5QXJyYXk8R3JhcGhRTEVycm9yPiwgcGF0aEluZGV4OiBudW1iZXIpOiBTb3J0ZWRFcnJvcnMge1xuICBjb25zdCBlcnJvck1hcCA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gIGNvbnN0IHVucGF0aGVkRXJyb3JzOiBTZXQ8R3JhcGhRTEVycm9yPiA9IG5ldyBTZXQoKTtcbiAgZXJyb3JzLmZvckVhY2goZXJyb3IgPT4ge1xuICAgIGNvbnN0IHBhdGhTZWdtZW50ID0gZXJyb3IucGF0aD8uW3BhdGhJbmRleF07XG4gICAgaWYgKHBhdGhTZWdtZW50ID09IG51bGwpIHtcbiAgICAgIHVucGF0aGVkRXJyb3JzLmFkZChlcnJvcik7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHBhdGhTZWdtZW50IGluIGVycm9yTWFwKSB7XG4gICAgICBlcnJvck1hcFtwYXRoU2VnbWVudF0ucHVzaChlcnJvcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGVycm9yTWFwW3BhdGhTZWdtZW50XSA9IFtlcnJvcl07XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4ge1xuICAgIGVycm9yTWFwLFxuICAgIHVucGF0aGVkRXJyb3JzLFxuICB9O1xufVxuXG5mdW5jdGlvbiBhZGRQYXRoU2VnbWVudEluZm8oXG4gIHR5cGU6IEdyYXBoUUxPYmplY3RUeXBlLFxuICBmaWVsZE5hbWU6IHN0cmluZyxcbiAgcGF0aEluZGV4OiBudW1iZXIsXG4gIGVycm9yczogUmVhZG9ubHlBcnJheTxHcmFwaFFMRXJyb3I+ID0gW10sXG4gIGVycm9ySW5mbzogRXJyb3JJbmZvXG4pIHtcbiAgZXJyb3JzLmZvckVhY2goZXJyb3IgPT4ge1xuICAgIGNvbnN0IHNlZ21lbnRJbmZvID0ge1xuICAgICAgdHlwZSxcbiAgICAgIGZpZWxkTmFtZSxcbiAgICAgIHBhdGhJbmRleCxcbiAgICB9O1xuICAgIGNvbnN0IHBhdGhTZWdtZW50c0luZm8gPSBlcnJvckluZm8uc2VnbWVudEluZm9NYXAuZ2V0KGVycm9yKTtcbiAgICBpZiAocGF0aFNlZ21lbnRzSW5mbyA9PSBudWxsKSB7XG4gICAgICBlcnJvckluZm8uc2VnbWVudEluZm9NYXAuc2V0KGVycm9yLCBbc2VnbWVudEluZm9dKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGF0aFNlZ21lbnRzSW5mby5wdXNoKHNlZ21lbnRJbmZvKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjb2xsZWN0U3ViRmllbGRzKFxuICBleGVDb250ZXh0OiBHcmFwaFFMRXhlY3V0aW9uQ29udGV4dCxcbiAgdHlwZTogR3JhcGhRTE9iamVjdFR5cGUsXG4gIGZpZWxkTm9kZXM6IEFycmF5PEZpZWxkTm9kZT5cbik6IFJlY29yZDxzdHJpbmcsIEFycmF5PEZpZWxkTm9kZT4+IHtcbiAgbGV0IHN1YkZpZWxkTm9kZXM6IFJlY29yZDxzdHJpbmcsIEFycmF5PEZpZWxkTm9kZT4+ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgY29uc3QgdmlzaXRlZEZyYWdtZW50TmFtZXMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG4gIGZpZWxkTm9kZXMuZm9yRWFjaChmaWVsZE5vZGUgPT4ge1xuICAgIHN1YkZpZWxkTm9kZXMgPSBjb2xsZWN0RmllbGRzKGV4ZUNvbnRleHQsIHR5cGUsIGZpZWxkTm9kZS5zZWxlY3Rpb25TZXQsIHN1YkZpZWxkTm9kZXMsIHZpc2l0ZWRGcmFnbWVudE5hbWVzKTtcbiAgfSk7XG5cbiAgcmV0dXJuIHN1YkZpZWxkTm9kZXM7XG59XG4iXSwidmVyc2lvbiI6M30=